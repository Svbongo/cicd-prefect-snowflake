name: Nightly SQL Release

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'  # 2AM EST / 6AM UTC

permissions:
  contents: write

jobs:
  nightly-sql-release:
    if: github.ref == 'refs/heads/cicd-sql-release'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cicd-sql-release branch
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: cicd-sql-release

      - name: Set up GitHub CLI
        run: |
          sudo apt update
          sudo apt install gh -y

      - name: Fetch main branch
        run: |
          git fetch origin main

      - name: Get list of all .sql files changed
        id: get_diff_files
        run: |
          BASE_COMMIT=$(git merge-base origin/main origin/cicd-sql-release)
          echo "Using merge base: $BASE_COMMIT"

          git diff --name-only $BASE_COMMIT..origin/cicd-sql-release | grep '\.sql$' > sorted_sql.txt || true
          echo "🧾 All changed SQL files:"
          cat sorted_sql.txt || echo "❌ None found"

      - name: Filter SQL files with real content changes (ignoring whitespace)
        run: |
          echo "📄 Filtering files with meaningful changes (ignoring whitespace)..."
          BASE_COMMIT=$(git merge-base origin/main origin/cicd-sql-release)
          rm -f filtered_sql.txt
          rm -f sql_diffs.log

          if [ -f sorted_sql.txt ]; then
            while read file; do
              echo "🔍 Checking $file"
              if git ls-tree -r "$BASE_COMMIT" --name-only | grep -Fqx "$file"; then
                DIFF=$(git diff -w -B "$BASE_COMMIT" -- "$file")
                if [ -n "$DIFF" ]; then
                  echo "$file" >> filtered_sql.txt
                  echo "🟢 $file" >> sql_diffs.log
                  echo "$DIFF" >> sql_diffs.log
                else
                  echo "⚪ Skipped (whitespace only): $file"
                fi
              else
                echo "$file" >> filtered_sql.txt
                echo "🟢 NEW FILE: $file" >> sql_diffs.log
                echo "-- new file --" >> sql_diffs.log
                cat "$file" >> sql_diffs.log
              fi
            done < sorted_sql.txt
          fi

          echo "✅ Final filtered files:"
          cat filtered_sql.txt || echo "❌ None"

      - name: Show line-by-line changes for SQL files (ignoring whitespace)
        run: |
          echo "📄 Showing detailed line-by-line changes for modified SQL files..."
          
          BASE_COMMIT=origin/main
          echo "📌 Using BASE_COMMIT: $BASE_COMMIT"
            
          if [ -f sorted_sql.txt ]; then
            while read file; do
              echo "🔍 Diff for: $file"
              echo "----------------------------------------"
            
                if git ls-tree -r "$BASE_COMMIT" --name-only | grep -Fqx "$file"; then
                  git diff -w -B "$BASE_COMMIT" -- "$file" || echo "⚠️ Diff failed"
                else
                  echo "⚠️ Skipped: File doesn't exist in base branch (new file)"
                fi
            
              echo ""
            done < sorted_sql.txt
          else
            echo "❌ sorted_sql.txt not found"
          fi
          
      - name: Normalize SQL keywords (CREATE, SELECT, etc.)
        run: |
          echo "🔧 Normalizing SQL keyword cases in modified files..."
          if [ -f filtered_sql.txt ]; then
            while read file; do
              if [ -f "$file" ]; then
                echo "⚙️ Normalizing $file"
                sed -i \
                  -e 's/\bcreate or replace\b/CREATE OR REPLACE/gI' \
                  -e 's/\bcreate table\b/CREATE TABLE/gI' \
                  -e 's/\bcreate view\b/CREATE VIEW/gI' \
                  -e 's/\bcreate procedure\b/CREATE PROCEDURE/gI' \
                  -e 's/\bdrop table\b/DROP TABLE/gI' \
                  -e 's/\bdrop view\b/DROP VIEW/gI' \
                  -e 's/\bdrop procedure\b/DROP PROCEDURE/gI' \
                  -e 's/\binsert into\b/INSERT INTO/gI' \
                  -e 's/\bvalues\b/VALUES/gI' \
                  -e 's/\bselect\b/SELECT/gI' \
                  -e 's/\bfrom\b/FROM/gI' \
                  -e 's/\bwhere\b/WHERE/gI' \
                  -e 's/\bjoin\b/JOIN/gI' \
                  -e 's/\bon\b/ON/gI' \
                  -e 's/\bgroup by\b/GROUP BY/gI' \
                  -e 's/\border by\b/ORDER BY/gI' \
                  -e 's/\bprimary key\b/PRIMARY KEY/gI' \
                  -e 's/\bforeign key\b/FOREIGN KEY/gI' \
                  -e 's/\bnot null\b/NOT NULL/gI' \
                  -e 's/\bnumber\b/NUMBER/gI' \
                  -e 's/\bvarchar\b/VARCHAR/gI' \
                  -e 's/\bdate\b/DATE/gI' \
                  "$file"
              fi
            done < filtered_sql.txt
          else
            echo "❌ No filtered_sql.txt found. Skipping normalization."
          fi

      - name: Create release notes from filtered files
        run: |
          echo "📝 Modified SQL Files:" > release_notes.md
          if [ -s filtered_sql.txt ]; then
            while read file; do
              echo "- $file" >> release_notes.md
            done < filtered_sql.txt
          else
            echo "- No SQL files with real changes" >> release_notes.md
          fi

      - name: Generate unique nightly tag
        id: generate_tag
        run: |
          BASE_TAG="nightly-$(date +%Y-%m-%d)"
          i=1
          while gh release view "${BASE_TAG}-$(printf "%03d" $i)" &>/dev/null; do
            i=$((i+1))
          done
          TAG_NAME="${BASE_TAG}-$(printf "%03d" $i)"
          echo "✅ Using tag: $TAG_NAME"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.HUB_TOKEN }}

      - name: Create new nightly release
        run: |
          gh release create "${{ steps.generate_tag.outputs.tag_name }}" \
            --title "Nightly SQL Release - $(date '+%Y-%m-%d %H:%M:%S')" \
            --notes-file release_notes.md \
            --target cicd-sql-release \
            --latest \
            filtered_sql.txt release_notes.md sql_diffs.log
        env:
          GH_TOKEN: ${{ secrets.HUB_TOKEN }}
