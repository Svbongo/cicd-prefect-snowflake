name: Nightly SQL Draft Release

on:
  schedule:
    - cron: '0 6 * * *'  # 2 AM EST
  workflow_dispatch:

permissions:
  contents: write

jobs:
  create-draft-release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install GitHub CLI
      run: |
        sudo apt update
        sudo apt install gh -y

    - name: Detect new/modified .sql files
      run: |
        git fetch --tags
        echo "Modified SQL Files:" > release_notes.md
        git diff --name-only HEAD~10 | grep '\.sql$' >> release_notes.md || echo "No changes."

    - name: Create GitHub Release without a tag (via API)
      env:
        GH_TOKEN: ${{ secrets.HUB_TOKEN }}
      run: |
        TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S')
        BODY=$(cat release_notes.md | jq -Rs .)
        curl -X POST https://api.github.com/repos/${{ github.repository }}/releases \
          -H "Authorization: token $GH_TOKEN" \
          -H "Accept: application/vnd.github+json" \
          -d "{
            \"tag_name\": \"nightly-placeholder\",
            \"target_commitish\": \"main\",
            \"name\": \"Nightly Release $TIMESTAMP\",
            \"body\": $BODY,
            \"draft\": false,
            \"prerelease\": false
          }"
  

