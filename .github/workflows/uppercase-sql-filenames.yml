name: Enforce Uppercase SQL Filenames

on:
  push:
    branches: [cicd-sql-release]  # or any branch you want
    paths:
      - '**/*.sql'

jobs:
  rename-sql-files:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Rename .sql files to UPPERCASE
        run: |
          renamed=0
          while IFS= read -r -d '' file; do
            dir=$(dirname "$file")
            base=$(basename "$file")
            upper_base=$(echo "$base" | tr '[:lower:]' '[:upper:]')

            if [ "$base" != "$upper_base" ]; then
              git mv "$file" "$dir/$upper_base"
              renamed=1
              echo "Renamed: $file -> $dir/$upper_base"
            fi
          done < <(find . -type f -iname '*.sql' -print0)

          if [ "$renamed" -eq 1 ]; then
            git config user.name "github-actions"
            git config user.email "github-actions@github.com"
            git commit -am "🔁 Auto-rename .sql files to UPPERCASE"
            git push
          else
            echo "✅ All .sql filenames already uppercase. No rename needed."
          fi
